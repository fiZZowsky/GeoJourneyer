@page "/login"
@inject ApiProxyClient ApiClient
@inject AuthState AuthState

<div class="login-container">
    <div class="form-selector">
        <span class="label">Login</span>
        <label class="switch">
            <input type="checkbox" @bind="isRegister" />
            <span class="slider"></span>
        </label>
        <span class="label">Register</span>
    </div>

    <div class="form-wrapper">
        @if (!isRegister)
        {
            <form class="auth-form" @onsubmit="OnLoginAsync" @onsubmit:preventDefault>
                <div class="input-group">
                    <Icon Name="Envelope" Class="icon" />
                    <input @bind="username" placeholder="name@mail.com" required />
                </div>
                <div class="input-group">
                    <Icon Name="Lock" Class="icon" />
                    <input type="@loginPasswordType" @bind="password" placeholder="Password" required />
                    <button type="button" class="reveal-btn"
                            @onmousedown="ShowLoginPassword" @onmouseup="HideLoginPassword" @onmouseleave="HideLoginPassword"
                            @ontouchstart="ShowLoginPassword" @ontouchend="HideLoginPassword">
                        <Icon Name="Eye" />
                    </button>
                </div>
                <button type="submit">Sign In</button>
            </form>
        }
        else
        {
            <form class="auth-form" @onsubmit="OnRegisterAsync" @onsubmit:preventDefault>
                <div class="input-group">
                    <Icon Name="User" Class="icon" />
                    <input @bind="regUsername" placeholder="Username" required />
                </div>
                <div class="input-group">
                    <Icon Name="Envelope" Class="icon" />
                    <input type="email" @bind="regEmail" placeholder="Email" required />
                </div>
                <div class="input-group">
                    <Icon Name="Lock" Class="icon" />
                    <input type="@regPasswordType" @bind="regPassword" placeholder="Password" required />
                    <button type="button" class="reveal-btn"
                            @onmousedown="ShowRegPassword" @onmouseup="HideRegPassword" @onmouseleave="HideRegPassword"
                            @ontouchstart="ShowRegPassword" @ontouchend="HideRegPassword">
                        <Icon Name="Eye" />
                    </button>
                </div>
                <div class="input-group">
                    <Icon Name="Lock" Class="icon" />
                    <input type="@regConfirmPasswordType" @bind="regPasswordConfirm" placeholder="Confirm Password" required />
                    <button type="button" class="reveal-btn"
                            @onmousedown="ShowRegConfirmPassword" @onmouseup="HideRegConfirmPassword" @onmouseleave="HideRegConfirmPassword"
                            @ontouchstart="ShowRegConfirmPassword" @ontouchend="HideRegConfirmPassword">
                        <Icon Name="Eye" />
                    </button>
                </div>
                <button type="submit">Sign Up</button>
            </form>
        }
        @if (!string.IsNullOrEmpty(Message))
        {
            <p class="message">@Message</p>
        }
    </div>
</div>

@code {
    private bool isRegister = false;

    private string? Message;
    private string username = string.Empty;
    private string password = string.Empty;
    private string regUsername = string.Empty;
    private string regEmail = string.Empty;
    private string regPassword = string.Empty;
    private string regPasswordConfirm = string.Empty;

    private string loginPasswordType = "password";
    private string regPasswordType = "password";
    private string regConfirmPasswordType = "password";

    private async Task OnLoginAsync()
    {
        var token = await ApiClient.PostAsync<object, string>(
            "api/auth/login",
            new { Username = username, Password = password });
        if (token != null)
        {
            ApiClient.SetToken(token);
            AuthState.SignIn(username, token);
            Message = "Logged in";
        }
        else
        {
            Message = "Invalid credentials";
        }
    }

    private async Task OnRegisterAsync()
    {
        if (regPassword != regPasswordConfirm)
        {
            Message = "Passwords do not match";
            return;
        }

        var token = await ApiClient.PostAsync<object, string>(
            "api/auth/register",
            new { Username = regUsername, Email = regEmail, Password = regPassword });
        if (token != null)
        {
            ApiClient.SetToken(token);
            AuthState.SignIn(regUsername, token);
            Message = "Registered";
        }
        else
        {
            Message = "Registration failed";
        }
    }

    private void ShowLoginPassword() => loginPasswordType = "text";
    private void HideLoginPassword() => loginPasswordType = "password";

    private void ShowRegPassword() => regPasswordType = "text";
    private void HideRegPassword() => regPasswordType = "password";

    private void ShowRegConfirmPassword() => regConfirmPasswordType = "text";
    private void HideRegConfirmPassword() => regConfirmPasswordType = "password";
}
